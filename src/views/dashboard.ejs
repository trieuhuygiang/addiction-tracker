<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        T·ªïng quan | C·ªë Tinh ƒê·∫°o T√¥ng
    </title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="/js/theme-init.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=EB+Garamond:wght@400;500;600;700&family=Crimson+Text:wght@400;600;700&family=Rajdhani:wght@600;700&family=Orbitron:wght@700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .dashboard-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            color: var(--info-color);
            font-size: 2rem;
            font-family: var(--font-display);
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            filter: brightness(0.95);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stats-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
            text-align: center;
        }

        .stats-card h2 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .stats-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--info-color);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            padding: 1rem;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
            transition: transform 0.3s, box-shadow 0.3s;
            display: inline-block;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, var(--gradient-end) 0%, var(--gradient-start) 100%);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 0 15px;
                margin: 1rem auto;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .stats-card {
                padding: 1.25rem 1rem;
            }

            .stats-card h2 {
                font-size: 0.7rem;
                margin-bottom: 0.5rem;
            }

            .stats-value {
                font-size: 1.75rem;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .quick-checkin {
                padding: 1.25rem !important;
            }

            .quick-checkin h2 {
                font-size: 1rem !important;
            }

            .quick-checkin-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .quick-checkin-buttons form,
            .quick-checkin-buttons a {
                width: 100%;
            }

            .quick-checkin-buttons button,
            .quick-checkin-buttons a {
                width: 100%;
                display: block;
                text-align: center;
            }

            .progress-section {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .progress-table {
                min-width: 500px;
            }

            .progress-table th,
            .progress-table td {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard-header h1 {
                font-size: 1.25rem;
            }

            .stats-card {
                padding: 1rem 0.75rem;
            }

            .stats-card h2 {
                font-size: 0.6rem;
            }

            .stats-value {
                font-size: 1.5rem;
            }

            .stats-card p {
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>
    <%- include('partials/header') %>

        <div class="dashboard-container">

            <div class="dashboard-header">
                <h1>ƒê·∫°o h·ªØu tr·ªü l·∫°i! üéâ</h1>
                <div style="font-size:1.1rem;color:var(--info-color);">ƒêang nh·∫≠p: <%= userName %>
                </div>
                <form method="POST" action="/logout" style="margin: 0;">
                    <button type="submit" class="logout-btn">ƒêƒÉng xu·∫•t</button>
                </form>
            </div>

            <% if (typeof deleteMessage !=='undefined' && deleteMessage) { %>
                <div
                    style="background: var(--bg-secondary); border: 1px solid var(--warning-color); color: var(--text-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üóëÔ∏è</span>
                    <span>
                        <%= deleteMessage %>
                    </span>
                </div>
                <% } %>

                    <!-- Rewiring Day Counter -->
                    <div class="rewiring-clock" id="rewiring-clock">
                        <h2 class="rewiring-clock-title">üß† B·ªô ƒë·∫øm ng√†y tu luy·ªán</h2>
                        <p class="rewiring-clock-subtitle">Th·ªùi gian k·ªÉ t·ª´ l·∫ßn sa ng√£ g·∫ßn nh·∫•t</p>

                        <% if (clockStartTime) { %>
                            <div id="clock-display" data-start-time="<%= clockStartTime.toISOString() %>"
                                class="watch-container">
                                <!-- Circular Watch Face -->
                                <div class="watch-face">
                                    <!-- Watch Ring -->
                                    <div class="watch-ring"></div>

                                    <!-- Main Display -->
                                    <div class="watch-center">
                                        <!-- Days Display (Top & Largest) -->
                                        <div class="days-section">
                                            <div id="clock-days" class="days-display">0</div>
                                            <div class="days-label">NG√ÄY</div>
                                        </div>

                                        <!-- Time Display (HH:MM:SS format with labels) -->
                                        <div class="time-display">
                                            <span class="time-group">
                                                <span id="clock-hours" class="time-value">00</span>
                                                <span class="time-unit">gi·ªù</span>
                                            </span>
                                            <span class="time-separator">:</span>
                                            <span class="time-group">
                                                <span id="clock-minutes" class="time-value">00</span>
                                                <span class="time-unit">ph√∫t</span>
                                            </span>
                                            <span class="time-separator">:</span>
                                            <span class="time-group">
                                                <span id="clock-seconds" class="time-value">00</span>
                                                <span class="time-unit">gi√¢y</span>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Decorative Elements (G-Shock style) -->
                                    <div class="watch-marker watch-marker-12"></div>
                                    <div class="watch-marker watch-marker-3"></div>
                                    <div class="watch-marker watch-marker-6"></div>
                                    <div class="watch-marker watch-marker-9"></div>
                                </div>
                            </div>

                            <!-- Counter Theme Toggle -->
                            <div style="margin: 1.5rem 0; text-align: center;">
                                <button class="counter-theme-toggle" id="counterThemeToggle"
                                    title="ƒê·ªïi phong c√°ch ƒë·ªìng h·ªì" onclick="toggleCounterTheme()"
                                    style="padding: 0.5rem; background: rgba(47, 59, 68, 0.10); border: 1px solid rgba(47, 59, 68, 0.25); color: var(--info-color); border-radius: 6px; cursor: pointer; font-size: 1.5rem; transition: all 0.3s; min-width: 50px; min-height: 50px; display: inline-flex; align-items: center; justify-content: center;">
                                    üé®
                                </button>
                            </div>

                            <!-- Rank Display -->
                            <div id="rank-display"
                                style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(47, 59, 68, 0.07); border-radius: 12px; border: 2px solid rgba(47, 59, 68, 0.18);">
                                <div
                                    style="display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                    <div id="rank-icon" style="font-size: 3rem;">üåÄ</div>
                                    <div style="text-align: left;">
                                        <div id="rank-title"
                                            style="font-size: 1.4rem; font-weight: bold; color: var(--info-color);">
                                            Luy·ªán Kh√≠ -
                                            T·∫ßng 1</div>
                                        <div id="rank-subtitle"
                                            style="color: var(--text-secondary); font-size: 0.85rem; opacity: 0.7;">B·∫Øt
                                            ƒë·∫ßu t·ª• kh√≠
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <div id="rank-progress-container"
                                        style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 12px; overflow: hidden;">
                                        <div id="rank-progress-bar"
                                            style="height: 100%; background: linear-gradient(90deg, var(--sect-jade), var(--sect-seal)); border-radius: 10px; transition: width 0.5s ease; width: 0%;">
                                        </div>
                                    </div>
                                    <div id="rank-progress-text"
                                        style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">
                                        0 ng√†y ƒë·∫øn c·∫£nh gi·ªõi
                                        ti·∫øp theo
                                    </div>
                                </div>
                            </div>

                            <form method="POST" action="/clock/reset" id="clock-reset-form" style="display: inline;">
                                <button type="submit"
                                    onclick="return confirm('‚ö†Ô∏è B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·∫∑t l·∫°i b·ªô ƒë·∫øm? Chu·ªói hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠.');"
                                    style="padding: 0.75rem 2rem; background: var(--danger-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s;">
                                    üîÑ ƒê·∫∑t l·∫°i b·ªô ƒë·∫øm
                                </button>
                            </form>
                            <button type="button" onclick="showEmergencyQuote()"
                                style="padding: 0.75rem 2rem; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; margin-left: 0.5rem;">
                                üôè Kh·∫©n c·∫•p
                            </button>
                            <% } else { %>
                                <div id="clock-display-inactive" class="watch-container watch-inactive">
                                    <!-- Circular Watch Face -->
                                    <div class="watch-face">
                                        <!-- Watch Ring -->
                                        <div class="watch-ring"></div>

                                        <!-- Main Display -->
                                        <div class="watch-center">
                                            <!-- Days Display (Top & Largest) -->
                                            <div class="days-section">
                                                <div class="days-display">0</div>
                                                <div class="days-label">NG√ÄY</div>
                                            </div>

                                            <!-- Time Display (HH:MM:SS format with labels) -->
                                            <div class="time-display">
                                                <span class="time-group">
                                                    <span class="time-value">00</span>
                                                    <span class="time-unit">gi·ªù</span>
                                                </span>
                                                <span class="time-separator">:</span>
                                                <span class="time-group">
                                                    <span class="time-value">00</span>
                                                    <span class="time-unit">ph√∫t</span>
                                                </span>
                                                <span class="time-separator">:</span>
                                                <span class="time-group">
                                                    <span class="time-value">00</span>
                                                    <span class="time-unit">gi√¢y</span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Decorative Elements (G-Shock style) -->
                                        <div class="watch-marker watch-marker-12"></div>
                                        <div class="watch-marker watch-marker-3"></div>
                                        <div class="watch-marker watch-marker-6"></div>
                                        <div class="watch-marker watch-marker-9"></div>
                                    </div>
                                </div>
                                <p
                                    style="color: var(--text-muted); margin-top: 1rem; margin-bottom: 1.5rem; text-align: center; font-size: 0.95rem;">
                                    ‚è∏Ô∏è Ch∆∞a kh·ªüi ƒë·ªông b·ªô ƒë·∫øm</p>

                                <button type="button" onclick="startClockNow()"
                                    style="padding: 0.75rem 2rem; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s;">
                                    ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu
                                </button>
                                <button type="button" onclick="showEmergencyQuote()"
                                    style="padding: 0.75rem 2rem; background: var(--info-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; margin-left: 0.5rem;">
                                    üôè Kh·∫©n c·∫•p
                                </button>
                                <% } %>

                                    <div
                                        style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                        <a href="/clock-history"
                                            style="color: var(--info-color); text-decoration: none; font-size: 0.9rem;">
                                            üìú L·ªãch s·ª≠ tu luy·ªán
                                        </a>
                                        <span style="color: #444;">|</span>
                                        <a href="#" onclick="showRankingSystem(); return false;"
                                            style="color: var(--danger-color); text-decoration: none; font-size: 0.9rem;">
                                            üßò Xem C·∫£nh Gi·ªõi
                                        </a>
                                        <span style="color: #444;">|</span>
                                        <a href="#" onclick="showEditCounter(); return false;"
                                            style="color: var(--info-color); text-decoration: none; font-size: 0.9rem;">
                                            ‚úèÔ∏è Ch·ªânh b·ªô ƒë·∫øm
                                        </a>
                                    </div>
                    </div>

                    <!-- Quick Check-in for Today -->
                    <div class="quick-checkin"
                        style="background: var(--card-bg); padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px var(--shadow-color); margin-bottom: 2rem;">
                        <h2 style="color: var(--info-color); margin-bottom: 1rem;">üìã ƒêi·ªÉm danh h√¥m nay (<%= today %>)
                        </h2>
                        <% if (todayEntry) { %>
                            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <div style="font-size: 2rem;">
                                    <% if (todayEntry.failure_level===2) { %>
                                        üíÄ
                                        <% } else if (todayEntry.failure_level===1 || todayEntry.had_leakage) { %>
                                            ‚ö†Ô∏è
                                            <% } else { %>
                                                ‚úÖ
                                                <% } %>
                                </div>
                                <div style="flex: 1; min-width: 150px;">
                                    <p
                                        style="font-weight: bold; color: <%= todayEntry.failure_level === 2 ? 'var(--danger-color)' : (todayEntry.failure_level === 1 || todayEntry.had_leakage) ? 'var(--warning-color)' : 'var(--success-color)' %>;">
                                        H√¥m nay: <%= todayEntry.failure_level===2 ? 'Th·∫•t th·ªß' :
                                            (todayEntry.failure_level===1 || todayEntry.had_leakage) ? 'S∆° su·∫•t'
                                            : 'Thanh t·ªãnh' %>
                                    </p>
                                    <% if (todayEntry.note) { %>
                                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Ghi ch√∫: <%=
                                                todayEntry.note %>
                                        </p>
                                        <% } %>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <a href="/entries/<%= today %>"
                                        style="padding: 0.75rem 1.25rem; background: var(--info-color); color: white; border-radius: 8px; text-decoration: none; font-size: 0.9rem; font-weight: 600;">S·ª≠a</a>
                                </div>
                            </div>
                            <% } else { %>
                                <p style="color: var(--text-secondary); margin-bottom: 1rem;">H√¥m nay b·∫°n ch∆∞a ghi.
                                    Ng√†y tu luy·ªán th·∫ø n√†o?</p>
                                <div class="quick-checkin-buttons"
                                    style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                    <form method="POST" action="/entries/quick" style="flex: 1; min-width: 100px;">
                                        <input type="hidden" name="date" value="<%= today %>">
                                        <input type="hidden" name="failureLevel" value="0">
                                        <button type="submit"
                                            style="width: 100%; padding: 1rem; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">
                                            ‚úÖ Thanh t·ªãnh
                                        </button>
                                    </form>
                                    <form method="POST" action="/entries/quick" style="flex: 1; min-width: 100px;">
                                        <input type="hidden" name="date" value="<%= today %>">
                                        <input type="hidden" name="failureLevel" value="1">
                                        <button type="submit"
                                            style="width: 100%; padding: 1rem; background: var(--warning-color); color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">
                                            ‚ö†Ô∏è S∆° su·∫•t
                                        </button>
                                    </form>
                                    <form method="POST" action="/entries/quick" style="flex: 1; min-width: 100px;">
                                        <input type="hidden" name="date" value="<%= today %>">
                                        <input type="hidden" name="failureLevel" value="2">
                                        <button type="submit"
                                            style="width: 100%; padding: 1rem; background: var(--danger-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">
                                            üíÄ Th·∫•t th·ªß
                                        </button>
                                    </form>
                                    <a href="/entries/<%= today %>"
                                        style="flex: 1; min-width: 100px; padding: 1rem; background: var(--info-color); color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 0.9rem; font-weight: bold; text-align: center; display: flex; align-items: center; justify-content: center;">
                                        üìù Th√™m ghi ch√∫
                                    </a>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label
                                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px; width: fit-content;">
                                        <input type="checkbox" id="dashboardMorningWood" <% if (todayEntry &&
                                            todayEntry.has_morning_wood) { %>checked<% } %>
                                            style="width: 18px; height: 18px; cursor: pointer; accent-color:
                                            var(--sect-jade);">
                                            <span style="color: var(--text-primary);">üå≥ D·∫•u hi·ªáu h·ªìi ph·ª•c (s√°ng)</span>
                                    </label>
                                    <div
                                        style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px; margin-left: 30px;">
                                        T√≠n hi·ªáu t·ªët cho qu√° tr√¨nh h·ªìi ph·ª•c
                                    </div>
                                </div>
                                <script>
                                    document.getElementById('dashboardMorningWood').addEventListener('change', function () {
                                        fetch('/entries/<%= today %>/morning-wood', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({ hasMorningWood: this.checked })
                                        }).then(response => {
                                            if (!response.ok) {
                                                alert('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªìi ph·ª•c');
                                                this.checked = !this.checked;
                                            }
                                        }).catch(error => {
                                            console.error('Error:', error);
                                            alert('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªìi ph·ª•c');
                                            this.checked = !this.checked;
                                        });
                                    });
                                </script>
                                <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                                    <form method="POST" action="/entries/relapse" style="width: 100%;"
                                        onsubmit="return confirm('‚ö†Ô∏è T√ÅI NG√É - Thao t√°c n√†y s·∫Ω ƒë·∫∑t l·∫°i TO√ÄN B·ªò ti·∫øn ƒë·ªô. B·∫°n ch·∫Øc ch·ª©?') && confirm('Kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n ch·∫Øc ch·∫Øn l·∫ßn n·ªØa ch·ª©?');">
                                        <button type="submit"
                                            style="width: 100%; padding: 0.75rem 1.5rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">
                                            üíî T√°i ng√£ (ƒê·∫∑t l·∫°i to√†n b·ªô ti·∫øn ƒë·ªô)
                                        </button>
                                    </form>
                                </div>
                                <% } %>
                    </div>

                    <script>
                        // Start clock immediately via AJAX
                        function startClockNow() {
                            // Start clock on server
                            fetch('/clock/start', {
                                method: 'POST',
                                credentials: 'same-origin'
                            })
                                .then(response => {
                                    if (response.ok) {
                                        // Instead of reloading, show the clock immediately
                                        const inactiveDisplay = document.getElementById('clock-display-inactive');
                                        if (inactiveDisplay) {
                                            inactiveDisplay.remove();
                                        }

                                        // Remove "Counter not started" message
                                        const notStartedMsg = inactiveDisplay?.nextElementSibling;
                                        if (notStartedMsg) {
                                            notStartedMsg.remove();
                                        }

                                        // Remove start button
                                        const startForm = document.querySelector('form[action="/clock/start"]')?.parentElement;
                                        if (startForm) {
                                            startForm.remove();
                                        }

                                        // Create active clock display
                                        const container = document.querySelector('.rewiring-clock');
                                        const startTime = new Date().toISOString();

                                        const clockHTML = `
                                        <div id="clock-display" data-start-time="${startTime}" class="watch-container">
                                            <div class="watch-face">
                                                <div class="watch-ring"></div>
                                                <div class="watch-center">
                                                    <div class="days-section">
                                                        <div id="clock-days" class="days-display">0</div>
                                                        <div class="days-label">NG√ÄY</div>
                                                    </div>
                                                    <div class="time-display">
                                                        <span class="time-group">
                                                            <span id="clock-hours" class="time-value">00</span>
                                                            <span class="time-unit">gi·ªù</span>
                                                        </span>
                                                        <span class="time-separator">:</span>
                                                        <span class="time-group">
                                                            <span id="clock-minutes" class="time-value">00</span>
                                                            <span class="time-unit">ph√∫t</span>
                                                        </span>
                                                        <span class="time-separator">:</span>
                                                        <span class="time-group">
                                                            <span id="clock-seconds" class="time-value">00</span>
                                                            <span class="time-unit">gi√¢y</span>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="watch-marker watch-marker-12"></div>
                                                <div class="watch-marker watch-marker-3"></div>
                                                <div class="watch-marker watch-marker-6"></div>
                                                <div class="watch-marker watch-marker-9"></div>
                                            </div>
                                        </div>
                                        <div style="margin: 1.5rem 0; text-align: center;">
                                            <button class="counter-theme-toggle" id="counterThemeToggle" title="ƒê·ªïi giao di·ªán b·ªô ƒë·∫øm" onclick="toggleCounterTheme()" style="padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--info-color); border-radius: 6px; cursor: pointer; font-size: 1.5rem; transition: all 0.3s; min-width: 50px; min-height: 50px; display: inline-flex; align-items: center; justify-content: center;">üé®</button>
                                        </div>
                                        <div id="rank-display" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 12px; border: 2px solid var(--border-color);">
                                            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                                <div id="rank-icon" style="font-size: 3rem;">üåÄ</div>
                                                <div style="text-align: left;">
                                                    <div id="rank-title" style="font-size: 1.4rem; font-weight: bold; color: var(--info-color);">Luy·ªán Kh√≠ - T·∫ßng 1</div>
                                                    <div id="rank-subtitle" style="color: var(--text-secondary); font-size: 0.85rem; opacity: 0.7;">B·∫Øt ƒë·∫ßu t·ª• kh√≠</div>
                                                </div>
                                            </div>
                                            <div style="margin-top: 1rem;">
                                                <div id="rank-progress-container" style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 12px; overflow: hidden;">
                                                    <div id="rank-progress-bar" style="height: 100%; background: linear-gradient(90deg, var(--sect-jade), var(--sect-seal)); border-radius: 10px; transition: width 0.5s ease; width: 0%;"></div>
                                                </div>
                                                <div id="rank-progress-text" style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">0 ng√†y ƒë·∫øn c·∫£nh gi·ªõi ti·∫øp theo</div>
                                            </div>
                                        </div>
                                        <form method="POST" action="/clock/reset" id="clock-reset-form" style="display: inline;">
                                            <button type="submit" onclick="return confirm('‚ö†Ô∏è B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·∫∑t l·∫°i b·ªô ƒë·∫øm? Thao t√°c n√†y s·∫Ω l∆∞u chu·ªói hi·ªán t·∫°i v√†o l·ªãch s·ª≠.');" style="padding: 0.75rem 2rem; background: var(--danger-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s;">üîÑ ƒê·∫∑t l·∫°i b·ªô ƒë·∫øm</button>
                                        </form>
                                        <button type="button" onclick="showEmergencyQuote()" style="padding: 0.75rem 2rem; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; margin-left: 0.5rem;">üôè Ch·ªëng t√¢m ma</button>
                                    `;

                                        const subtitle = container.querySelector('.rewiring-clock-subtitle');
                                        subtitle.insertAdjacentHTML('afterend', clockHTML);

                                        // Start the clock timer immediately
                                        initializeClock();
                                    } else {
                                        alert('Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông b·ªô ƒë·∫øm. Vui l√≤ng th·ª≠ l·∫°i.');
                                    }
                                })
                                .catch(error => {
                                    console.error('Clock start error:', error);
                                    alert('Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông b·ªô ƒë·∫øm. Vui l√≤ng th·ª≠ l·∫°i.');
                                });
                        }

                        // Ranking System - C·∫£nh gi·ªõi tu ti√™n (Global scope for access by showRankingSystem)
                        const ranks = [
                            // Luy·ªán Kh√≠ (1-9)
                            { days: 0, icon: 'üåÄ', title: 'Luy·ªán Kh√≠ - T·∫ßng 1', subtitle: 'B·∫Øt ƒë·∫ßu t·ª• kh√≠', color: '#2E7D32' },
                            { days: 2, icon: 'üå¨Ô∏è', title: 'Luy·ªán Kh√≠ - T·∫ßng 2', subtitle: 'H√¥ h·∫•p ƒëi·ªÅu h√≤a, t√¢m d·∫ßn tƒ©nh', color: '#388E3C' },
                            { days: 4, icon: 'üçÉ', title: 'Luy·ªán Kh√≠ - T·∫ßng 3', subtitle: 'Kh√≠ m·∫°ch th√¥ng su·ªët h∆°n', color: '#43A047' },
                            { days: 7, icon: 'üßò', title: 'Luy·ªán Kh√≠ - T·∫ßng 4', subtitle: '√ù ch√≠ b√©n, th√≥i quen h√¨nh th√†nh', color: '#4CAF50' },
                            { days: 10, icon: 'ü´ß', title: 'Luy·ªán Kh√≠ - T·∫ßng 5', subtitle: 'T·∫°p ni·ªám gi·∫£m, t·ª± ch·ªß tƒÉng', color: '#66BB6A' },
                            { days: 14, icon: 'üî∞', title: 'Luy·ªán Kh√≠ - T·∫ßng 6', subtitle: 'Kh√≠ t·ª©c ·ªïn ƒë·ªãnh, t√¢m kh√¥ng lo·∫°n', color: '#7CB342' },
                            { days: 18, icon: 'ü™∑', title: 'Luy·ªán Kh√≠ - T·∫ßng 7', subtitle: 'Gi·ªØ gi·ªõi v·ªØng, l√≤ng b·ªÅn', color: '#8BC34A' },
                            { days: 23, icon: 'üí†', title: 'Luy·ªán Kh√≠ - T·∫ßng 8', subtitle: 'Kh√≠ t·ª• d√†y, tinh th·∫ßn s√°ng', color: '#9CCC65' },
                            { days: 30, icon: 'üóø', title: 'Luy·ªán Kh√≠ - T·∫ßng 9', subtitle: 'Vi√™n m√£n luy·ªán kh√≠, chu·∫©n b·ªã tr√∫c c∆°', color: '#00E676' },

                            // Tr√∫c C∆°
                            { days: 40, icon: 'üß±', title: 'Tr√∫c C∆° - S∆° K·ª≥', subtitle: 'CƒÉn c∆° d·ª±ng l·∫≠p, t√¢m ·ªïn ƒë·ªãnh', color: '#00838F' },
                            { days: 55, icon: 'üèóÔ∏è', title: 'Tr√∫c C∆° - Trung K·ª≥', subtitle: 'CƒÉn c∆° v·ªØng ch·∫Øc, ti·∫øn b·ªô r√µ r·ªát', color: '#00ACC1' },
                            { days: 70, icon: 'üèØ', title: 'Tr√∫c C∆° - H·∫≠u K·ª≥', subtitle: 'N·ªÅn t·∫£ng ki√™n c·ªë, √≠t dao ƒë·ªông', color: '#26C6DA' },

                            // Kim ƒêan
                            { days: 90, icon: '‚ö™', title: 'Kim ƒêan - S∆° K·ª≥', subtitle: 'Ng∆∞ng t·ª• kim ƒëan, kh√≠ t·ª©c th√¢m h·∫≠u', color: '#283593' },
                            { days: 110, icon: 'üîµ', title: 'Kim ƒêan - Trung K·ª≥', subtitle: 'ƒêan l·ª±c tƒÉng, t√¢m c√†ng v·ªØng', color: '#3949AB' },
                            { days: 130, icon: 'üü£', title: 'Kim ƒêan - H·∫≠u K·ª≥', subtitle: 'ƒêan th√†nh vi√™n m√£n, ƒë·∫°o t√¢m s√°ng', color: '#5C6BC0' },

                            // Nguy√™n Anh
                            { days: 150, icon: 'üë∂', title: 'Nguy√™n Anh - S∆° K·ª≥', subtitle: 'T√¢m ph√°p tinh thu·∫ßn, nguy√™n anh th√†nh', color: '#4527A0' },
                            { days: 180, icon: 'üß†', title: 'Nguy√™n Anh - Trung K·ª≥', subtitle: 'Th·∫ßn ni·ªám m·∫°nh, t·ª± ch·ªß cao', color: '#5E35B1' },
                            { days: 210, icon: 'üõ°Ô∏è', title: 'Nguy√™n Anh - H·∫≠u K·ª≥', subtitle: 'Ch·ªëng t√¢m ma t·ªët, ki√™n ƒë·ªãnh', color: '#7E57C2' },

                            // H√≥a Th·∫ßn
                            { days: 240, icon: '‚ú®', title: 'H√≥a Th·∫ßn - S∆° K·ª≥', subtitle: 'Th·∫ßn ni·ªám khai m·ªü, kh√≠ th·∫ßn h·ª£p', color: '#AD1457' },
                            { days: 270, icon: 'üî•', title: 'H√≥a Th·∫ßn - Trung K·ª≥', subtitle: '√ù ch√≠ b·ªÅn, d·ª•c v·ªçng suy', color: '#D81B60' },
                            { days: 300, icon: 'üåå', title: 'H√≥a Th·∫ßn - H·∫≠u K·ª≥', subtitle: 'T√¢m s√°ng nh∆∞ g∆∞∆°ng, ƒë·ªãnh l·ª±c s√¢u', color: '#EC407A' },

                            // Cao c·∫£nh
                            { days: 330, icon: '‚òÅÔ∏è', title: 'Luy·ªán H∆∞', subtitle: 'H∆∞ th·ª±c t∆∞∆°ng dung, t√¢m c·∫£nh r·ªông m·ªü', color: '#6A1B9A' },
                            { days: 365, icon: 'ü§ù', title: 'H·ª£p Th·ªÉ', subtitle: 'T√¢m-th√¢n h·ª£p nh·∫•t, ƒë·∫°o t√¢m v·ªØng v√†ng', color: '#8E24AA' },
                            { days: 420, icon: 'üèîÔ∏è', title: 'ƒê·∫°i Th·ª´a', subtitle: 'ƒê·∫°o h·∫°nh s√¢u d√†y, kh√≠ th·∫ø nh∆∞ s∆°n', color: '#AB47BC' },

                            // ƒê·ªô Ki·∫øp (nhi·ªÅu tr·ªçng)
                            { days: 500, icon: '‚ö°', title: 'ƒê·ªô Ki·∫øp - Nh·∫•t Tr·ªçng', subtitle: 'V∆∞·ª£t ch∆∞·ªõng ng·∫°i ƒë·∫ßu ti√™n', color: '#F57C00' },
                            { days: 600, icon: '‚õàÔ∏è', title: 'ƒê·ªô Ki·∫øp - Nh·ªã Tr·ªçng', subtitle: 'T√¢m ma kh√≥, v·∫´n kh√¥ng l√πi', color: '#FF9800' },
                            { days: 730, icon: 'üå©Ô∏è', title: 'ƒê·ªô Ki·∫øp - Tam Tr·ªçng', subtitle: 'Ki√™n tr√¨ l√¢u d√†i, kh√≠ v·∫≠n m·ªü', color: '#FFB74D' },

                            // Ti√™n
                            { days: 850, icon: 'üëë', title: 'Ti√™n V∆∞∆°ng', subtitle: 'Danh ch·∫•n t·ª© ph∆∞∆°ng, ƒë·∫°o l·ª±c h√πng h·∫≠u', color: '#E040FB' },
                            { days: 1000, icon: 'üåû', title: 'Ti√™n ƒê·∫ø', subtitle: 'Ng√†n ng√†y ki√™n tr√¨, b∆∞·ªõc v√†o c·∫£nh gi·ªõi t·ªëi th∆∞·ª£ng', color: '#FFFFFF' }
                        ];

                        // Initialize clock timer
                        function initializeClock() {
                            const clockDisplay = document.getElementById('clock-display');
                            if (!clockDisplay) return;

                            const startTime = clockDisplay.dataset.startTime;
                            if (!startTime) return;

                            const startDate = new Date(startTime);

                            function updateClock() {
                                const now = new Date();
                                const diff = Math.max(0, Math.floor((now - startDate) / 1000));

                                const days = Math.floor(diff / 86400);
                                const hours = Math.floor((diff % 86400) / 3600);
                                const minutes = Math.floor((diff % 3600) / 60);
                                const seconds = diff % 60;

                                document.getElementById('clock-days').textContent = days;
                                document.getElementById('clock-hours').textContent = hours.toString().padStart(2, '0');
                                document.getElementById('clock-minutes').textContent = minutes.toString().padStart(2, '0');
                                document.getElementById('clock-seconds').textContent = seconds.toString().padStart(2, '0');

                                // Update rank based on days
                                updateRank(days);
                            }

                            function updateRank(days) {
                                let currentRank = ranks[0];
                                let nextRank = ranks[1];
                                let currentRankIndex = 0;

                                for (let i = ranks.length - 1; i >= 0; i--) {
                                    if (days >= ranks[i].days) {
                                        currentRank = ranks[i];
                                        currentRankIndex = i;
                                        nextRank = ranks[i + 1] || null;
                                        break;
                                    }
                                }

                                // Manual per-rank styling: low rank darker/muted, high rank brighter
                                const titleColor = currentRank.color;
                                const titleOpacity = 1;
                                const textOpacity = 0.9;
                                const textWeight = 600;

                                // Update display
                                document.getElementById('rank-icon').textContent = currentRank.icon;
                                document.getElementById('rank-title').textContent = currentRank.title;
                                const titleEl = document.getElementById('rank-title');
                                titleEl.style.color = titleColor;
                                titleEl.style.opacity = titleOpacity;
                                titleEl.style.fontWeight = '700';
                                document.getElementById('rank-subtitle').textContent = currentRank.subtitle;
                                const subtitleEl = document.getElementById('rank-subtitle');
                                subtitleEl.style.color = 'var(--text-secondary)';
                                subtitleEl.style.opacity = textOpacity;
                                subtitleEl.style.fontWeight = textWeight;

                                // Update progress bar
                                if (nextRank) {
                                    const progressDays = days - currentRank.days;
                                    const totalDays = nextRank.days - currentRank.days;
                                    const progressPercent = Math.min((progressDays / totalDays) * 100, 100);
                                    const daysToNext = nextRank.days - days;

                                    document.getElementById('rank-progress-bar').style.width = progressPercent + '%';
                                    document.getElementById('rank-progress-bar').style.background = `linear-gradient(90deg, ${currentRank.color}, ${nextRank.color})`;
                                    const progressEl = document.getElementById('rank-progress-text');
                                    progressEl.style.color = 'var(--text-secondary)';
                                    progressEl.style.opacity = textOpacity;
                                    progressEl.style.fontWeight = textWeight;

                                    progressEl.innerHTML = `<span style="color: ${nextRank.color}; font-weight: 700; opacity: 1;">${nextRank.icon} ${nextRank.title}</span> c√≤n ${daysToNext} ng√†y`;
                                } else {
                                    // Max rank reached
                                    document.getElementById('rank-progress-bar').style.width = '100%';
                                    document.getElementById('rank-progress-bar').style.background = `linear-gradient(90deg, ${currentRank.color}, gold)`;
                                    const progressEl = document.getElementById('rank-progress-text');
                                    progressEl.style.color = currentRank.color;
                                    progressEl.style.opacity = 1;
                                    progressEl.style.fontWeight = 700;
                                    progressEl.innerHTML = 'üéä ƒê·∫°t c·∫£nh gi·ªõi t·ªëi th∆∞·ª£ng!';
                                }
                            }

                            updateClock();
                            setInterval(updateClock, 1000);
                        }

                        // NoFap Clock Timer - Initialize if clock exists
                        initializeClock();

                        // Kh·∫©u quy·∫øt kh·∫©n c·∫•p (ti·∫øng Vi·ªát)
                        const emergencyQuotes = [
                            { text: "H√≠t s√¢u m·ªôt h∆°i. D·ª•c kh·ªüi th√¨ d·ª´ng, t√¢m lo·∫°n th√¨ l·∫Øng.", source: "Kh·∫©u quy·∫øt nh·∫≠p m√¥n", type: "mind" },
                            { text: "M·ªôt ph√∫t qua ƒë∆∞·ª£c h√¥m nay, l√† m·ªôt t·∫ßng v·ªØng h∆°n ng√†y mai.", source: "T√¥ng quy", type: "sect" },
                            { text: "ƒê·ªïi m√¥i tr∆∞·ªùng ngay: ƒë·ª©ng d·∫≠y, r·ªùi m√†n h√¨nh, u·ªëng n∆∞·ªõc.", source: "Ph√°p m√¥n th·ª±c h√†nh", type: "mind" },
                            { text: "T√¢m ma ch·ªâ m·∫°nh khi ta ƒë·ª©ng y√™n.", source: "Truy·ªÅn th·ª´a", type: "sect" },
                            { text: "ƒê·ª´ng th∆∞∆°ng l∆∞·ª£ng v·ªõi c∆°n th√®m. C·∫Øt ƒë·ª©t, r·ªìi ƒëi.", source: "N·ªôi quy", type: "sect" },
                            { text: "Gi·ªØ gi·ªõi l√† gi·ªØ kh√≠. Gi·ªØ kh√≠ l√† gi·ªØ ƒë·∫°o.", source: "T√¥ng ch·ªß d·∫°y", type: "sect" },
                            { text: "Ng·∫Øn h·∫°n: ch·ªãu kh√≥. D√†i h·∫°n: t·ª± do.", source: "Ghi ch√∫ tu luy·ªán", type: "mind" },
                            { text: "N·∫øu mu·ªën g·ª•c, h√£y g·ª•c khi ƒë√£ r·ªùi kh·ªèi ch·ªó nguy hi·ªÉm.", source: "M·∫πo qua ki·∫øp", type: "mind" },
                            { text: "C∆°n s√≥ng d·ª•c r·ªìi c≈©ng qua. Vi·ªác c·ªßa ta l√† kh√¥ng nh·∫£y xu·ªëng n∆∞·ªõc.", source: "T√¢m ph√°p", type: "mind" },
                            { text: "T·∫Øt m·∫°ng, ƒë√≥ng tab, m·ªü c·ª≠a s·ªï. Cho kh√≠ tr·ªùi th·∫Øng kh√≠ d·ª•c.", source: "B√≠ k√≠p", type: "mind" },
                            { text: "H√¥m nay gi·ªØ ƒë∆∞·ª£c, danh d·ª± c·ªßa ng∆∞∆°i tƒÉng m·ªôt ph·∫ßn.", source: "T√¥ng m√¥n", type: "sect" },
                            { text: "M·ªôt l·∫ßn sa ng√£ k√©o d√†i m·ªôt ng√†y. M·ªôt l·∫ßn th·∫Øng t√¢m ma k√©o d√†i c·∫£ ƒë·ªùi.", source: "L·ªùi nh·∫Øc", type: "sect" },
                            { text: "Kh√¥ng c√¥ ƒë∆°n: h√£y nh·∫Øn cho ng∆∞·ªùi tin c·∫≠y ho·∫∑c ƒëi ra ch·ªó c√≥ ng∆∞·ªùi.", source: "Ph√°p m√¥n", type: "mind" },
                            { text: "T·ª± tr·ªçng l√† c√¥ng ph√°p t·ªëi th∆∞·ª£ng.", source: "Truy·ªÅn kh·∫©u", type: "sect" },
                            { text: "N√¢ng t·∫ßm m·ª•c ti√™u: tu luy·ªán v√¨ t∆∞∆°ng lai c·ªßa ch√≠nh m√¨nh.", source: "T√¢m ph√°p", type: "mind" },
                            { text: "ƒê·ª´ng t√¨m k√≠ch th√≠ch. H√£y t√¨m √Ω nghƒ©a.", source: "T√¥ng quy", type: "sect" },
                            { text: "M·ªôt ng√†y thanh t·ªãnh, m·ªôt b·∫≠c ti·∫øn ƒë·∫°o.", source: "C·ªï ng·ªØ", type: "sect" },
                            { text: "L√†m vi·ªác nh·ªè ngay b√¢y gi·ªù: ch·ªëng ƒë·∫©y 10 c√°i, ho·∫∑c ƒëi b·ªô 5 ph√∫t.", source: "Ph∆∞∆°ng ph√°p", type: "mind" }
                        ];

                        function showEmergencyQuote() {
                            const quote = emergencyQuotes[Math.floor(Math.random() * emergencyQuotes.length)];
                            // Set icon and label based on quote type
                            let icon, typeLabel;
                            switch (quote.type) {
                                case 'mind':
                                    icon = 'üßò';
                                    typeLabel = 'T√¢m ph√°p';
                                    break;
                                case 'sect':
                                    icon = 'üõ°Ô∏è';
                                    typeLabel = 'Kh·∫©u quy·∫øt';
                                    break;
                                default:
                                    icon = 'ü™∑';
                                    typeLabel = 'L·ªùi nh·∫Øc';
                            }

                            // Create modal
                            const modal = document.createElement('div');
                            modal.id = 'emergency-modal';
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;';

                            modal.innerHTML = `
                    <div style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); padding: 2rem; border-radius: 15px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: modalFadeIn 0.3s ease;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${icon}</div>
                        <div style="color: var(--info-color); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem;">${typeLabel}</div>
                        <p style="color: var(--text-primary); font-size: 1.2rem; line-height: 1.8; margin-bottom: 1.5rem; font-style: italic;">"${quote.text}"</p>
                        <p style="color: var(--danger-color); font-weight: bold; font-size: 1rem; margin-bottom: 2rem;">‚Äî ${quote.source}</p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showEmergencyQuote(); this.closest('#emergency-modal').remove();" style="padding: 0.75rem 1.5rem; background: var(--info-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                                üîÑ Th√™m m·ªôt c√¢u
                            </button>
                            <button onclick="this.closest('#emergency-modal').remove();" style="padding: 0.75rem 1.5rem; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                                üí™ Ta ƒë√£ v·ªØng t√¢m
                            </button>
                        </div>
                    </div>
                `;

                            // Remove existing modal if any
                            const existing = document.getElementById('emergency-modal');
                            if (existing) existing.remove();

                            document.body.appendChild(modal);

                            // Close on background click
                            modal.addEventListener('click', (e) => {
                                if (e.target === modal) modal.remove();
                            });

                            // Close on Escape key
                            document.addEventListener('keydown', function escHandler(e) {
                                if (e.key === 'Escape') {
                                    modal.remove();
                                    document.removeEventListener('keydown', escHandler);
                                }
                            });
                        }

                        // Show Ranking System Modal
                        function showRankingSystem() {
                            const rankList = ranks.map((rank, index) => {
                                const nextRank = ranks[index + 1];
                                const daysRange = nextRank ? `${rank.days} - ${nextRank.days - 1}` : `${rank.days}+`;

                                const titleColor = rank.color;
                                const titleOpacity = 1;
                                const textOpacity = 0.85;
                                const titleWeight = 700;
                                const subWeight = 600;
                                return `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid ${titleColor};">
                            <div style="font-size: 2rem; min-width: 50px; text-align: center;">${rank.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: ${titleWeight}; color: ${titleColor}; opacity: ${titleOpacity}; font-size: 1.1rem;">${rank.title}</div>
                                <div style="color: var(--text-secondary); opacity: ${textOpacity}; font-size: 0.85rem; font-weight: ${subWeight};">${rank.subtitle}</div>
                            </div>
                            <div style="color: var(--text-secondary); opacity: ${textOpacity}; font-size: 0.9rem; font-weight: ${titleWeight}; min-width: 80px; text-align: right;">
                                ${daysRange} ng√†y
                            </div>
                        </div>
                    `;
                            }).join('');

                            const modal = document.createElement('div');
                            modal.id = 'ranking-modal';
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;';

                            modal.innerHTML = `
                    <div style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); padding: 2rem; border-radius: 15px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: modalFadeIn 0.3s ease;">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üßò</div>
                            <h2 style="color: var(--sect-seal); margin: 0; font-size: 1.5rem;">C·∫£nh Gi·ªõi Tu Ti√™n</h2>
                            <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.9rem;">Con ƒë∆∞·ªùng tu luy·ªán c·ªßa b·∫°n</p>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            ${rankList}
                        </div>
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button onclick="this.closest('#ranking-modal').remove();" style="padding: 0.75rem 2rem; background: var(--info-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                                ‚úñÔ∏è ƒê√≥ng
                            </button>
                        </div>
                    </div>
                `;

                            const existing = document.getElementById('ranking-modal');
                            if (existing) existing.remove();

                            document.body.appendChild(modal);

                            modal.addEventListener('click', (e) => {
                                if (e.target === modal) modal.remove();
                            });

                            document.addEventListener('keydown', function escHandler(e) {
                                if (e.key === 'Escape') {
                                    modal.remove();
                                    document.removeEventListener('keydown', escHandler);
                                }
                            });
                        }

                        function showEditCounter() {
                            const clockDisplay = document.getElementById('clock-display');
                            if (!clockDisplay) {
                                alert('‚ö†Ô∏è B·ªô ƒë·∫øm ch∆∞a kh·ªüi ƒë·ªông. Vui l√≤ng kh·ªüi ƒë·ªông b·ªô ƒë·∫øm tr∆∞·ªõc.');
                                return;
                            }

                            const startTime = clockDisplay.dataset.startTime;
                            if (!startTime) {
                                alert('‚ö†Ô∏è B·ªô ƒë·∫øm ch∆∞a kh·ªüi ƒë·ªông. Vui l√≤ng kh·ªüi ƒë·ªông b·ªô ƒë·∫øm tr∆∞·ªõc.');
                                return;
                            }

                            const currentStart = new Date(startTime);
                            const now = new Date();
                            const diff = Math.max(0, Math.floor((now - currentStart) / 1000));

                            const currentDays = Math.floor(diff / 86400);
                            const currentHours = Math.floor((diff % 86400) / 3600);
                            const currentMinutes = Math.floor((diff % 3600) / 60);

                            const modal = document.createElement('div');
                            modal.id = 'edit-counter-modal';
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;';

                            modal.innerHTML = `
                    <div style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); padding: 2rem; border-radius: 15px; max-width: 500px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: modalFadeIn 0.3s ease;">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚úèÔ∏è</div>
                            <h2 style="color: var(--info-color); margin: 0; font-size: 1.5rem;">Ch·ªânh b·ªô ƒë·∫øm</h2>
                            <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.9rem;">ƒêi·ªÅu ch·ªânh th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu b·ªô ƒë·∫øm</p>
                        </div>
                        <form id="edit-counter-form" method="POST" action="/clock/edit">
                            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="color: var(--text-primary); font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Ng√†y</label>
                                    <input type="number" name="days" min="0" value="${currentDays}" required
                                        style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1rem; font-family: 'Courier New', monospace; font-weight: bold;">
                                </div>
                                <div>
                                    <label style="color: var(--text-primary); font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Gi·ªù (0-23)</label>
                                    <input type="number" name="hours" min="0" max="23" value="${currentHours}" required
                                        style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1rem; font-family: 'Courier New', monospace; font-weight: bold;">
                                </div>
                                <div>
                                    <label style="color: var(--text-primary); font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Ph√∫t (0-59)</label>
                                    <input type="number" name="minutes" min="0" max="59" value="${currentMinutes}" required
                                        style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1rem; font-family: 'Courier New', monospace; font-weight: bold;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s;">
                                    üíæ L∆∞u thay ƒë·ªïi
                                </button>
                                <button type="button" onclick="this.closest('#edit-counter-modal').remove();" style="padding: 0.75rem 1.5rem; background: var(--danger-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s;">
                                    ‚úñÔ∏è Hu·ª∑
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                            const existing = document.getElementById('edit-counter-modal');
                            if (existing) existing.remove();

                            document.body.appendChild(modal);

                            modal.addEventListener('click', (e) => {
                                if (e.target === modal) modal.remove();
                            });

                            document.addEventListener('keydown', function escHandler(e) {
                                if (e.key === 'Escape') {
                                    modal.remove();
                                    document.removeEventListener('keydown', escHandler);
                                }
                            });
                        }
                    </script>

                    <style>
                        @keyframes modalFadeIn {
                            from {
                                opacity: 0;
                                transform: scale(0.9);
                            }

                            to {
                                opacity: 1;
                                transform: scale(1);
                            }
                        }
                    </style>

                    <div class="dashboard-grid">
                        <div class="stats-card">
                            <h2>üî• Ng√†y tu luy·ªán</h2>
                            <div class="stats-value" id="stats-rewiring-days">
                                <% if (clockStartTime) { %>
                                    <script>
                                        document.write(Math.max(0, Math.floor((new Date() - new Date('<%= clockStartTime.toISOString() %>')) / 86400000)));
                                    </script>
                                    <% } else { %>
                                        0
                                        <% } %>
                            </div>
                            <p style="color: var(--text-muted); margin-top: 0.5rem;">t·ª´ l·∫ßn ƒë·∫∑t l·∫°i g·∫ßn nh·∫•t</p>
                        </div>

                        <div class="stats-card">
                            <h2>‚úÖ Ng√†y thanh t·ªãnh</h2>
                            <div class="stats-value">
                                <%= streakSummary.cleanDays %>
                            </div>
                            <p style="color: var(--text-muted); margin-top: 0.5rem;">ng√†y</p>
                        </div>

                        <div class="stats-card">
                            <h2>‚ö†Ô∏è S∆° su·∫•t</h2>
                            <div class="stats-value" style="color: var(--warning-color);">
                                <%= streakSummary.slipDays %>
                            </div>
                            <p style="color: var(--text-muted); margin-top: 0.5rem;">ng√†y</p>
                        </div>

                        <div class="stats-card">
                            <h2>üíÄ Th·∫•t th·ªß</h2>
                            <div class="stats-value" style="color: var(--danger-color);">
                                <%= streakSummary.totallyFailedDays %>
                            </div>
                            <p style="color: var(--text-muted); margin-top: 0.5rem;">ng√†y</p>
                        </div>
                    </div>

                    <h2 style="color: var(--text-primary); margin-bottom: 1rem;">H√†nh ƒë·ªông nhanh</h2>
                    <div class="action-buttons">
                        <a href="/entries" class="action-btn">üìù Ghi ch√©p</a>
                        <a href="/calendar" class="action-btn secondary">üìÖ L·ªãch</a>
                        <a href="/summary" class="action-btn">üìä Th·ªëng k√™</a>
                    </div>

                    <div style="margin-top: 2rem; text-align: center;">
                        <button type="button" onclick="confirmReset()" class="reset-btn"
                            style="background: var(--danger-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                            üóëÔ∏è Xo√° s·∫°ch ti·∫øn ƒë·ªô
                        </button>
                    </div>

                    <form id="resetForm" method="POST" action="/entries/reset-all" style="display: none;"></form>

                    <script>
                        function confirmReset() {
                            if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° TO√ÄN B·ªò ti·∫øn ƒë·ªô? Thao t√°c n√†y s·∫Ω xo√° m·ªçi ghi ch√©p v√† kh√¥ng th·ªÉ ho√†n t√°c!')) {
                                if (confirm('H√†nh ƒë·ªông n√†y l√† Vƒ®NH VI·ªÑN. B·∫°n c√≥ ch·∫Øc ch·∫Øn tuy·ªát ƒë·ªëi kh√¥ng?')) {
                                    document.getElementById('resetForm').submit();
                                }
                            }
                        }
                    </script>

                    <hr style="margin:2rem 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- Link to History Page -->
                    <div
                        style="background: var(--card-bg); padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px var(--shadow-color); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h2 style="color: var(--info-color); margin: 0 0 0.5rem 0;">üìä L·ªãch s·ª≠ tu luy·ªán</h2>
                            <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">
                                <% if (streakHistory && streakHistory.length> 0) { %>
                                    <%= streakHistory.length %> b·∫£n ghi ‚Ä¢ T·ªët nh·∫•t: üî• <%=
                                            Math.max(...streakHistory.map(r=> r.streak_days)) %> ng√†y
                                            <% } else { %>
                                                Ch∆∞a c√≥ b·∫£n ghi
                                                <% } %>
                            </p>
                        </div>
                        <a href="/history"
                            style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                            Xem l·ªãch s·ª≠ ‚Üí
                        </a>
                    </div>

                    <hr style="margin:2rem 0; border: none; border-top: 1px solid var(--border-color);">
                    <h2 style="color: var(--info-color); margin-bottom: 1rem;">Ti·∫øn ƒë·ªô c·ªßa b·∫°n</h2>
                    <% if (progressEntries && progressEntries.length> 0) { %>
                        <div class="progress-section" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                            <table class="progress-table"
                                style="width:100%;margin-bottom:2rem;border-collapse:collapse; min-width: 400px;">
                                <thead style="background: var(--bg-tertiary);">
                                    <tr>
                                        <th
                                            style="padding:0.75rem 0.5rem; text-align: left; color: var(--text-primary);">
                                            Ng√†y</th>
                                        <th
                                            style="padding:0.75rem 0.5rem; text-align: center; color: var(--text-primary);">
                                            Tr·∫°ng th√°i</th>
                                        <th style="padding:0.75rem 0.5rem; text-align: left; color: var(--text-primary);"
                                            class="hide-on-small">
                                            Ghi ch√∫</th>
                                        <th
                                            style="padding:0.75rem 0.5rem; text-align: center; color: var(--text-primary);">
                                            Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% const todayDate=new Date(today); progressEntries.forEach(entry=> {
                                        const entryDateStr = entry.date.toISOString().slice(0,10);
                                        const entryDate = new Date(entryDateStr);
                                        const isFuture = entryDate > todayDate;
                                        %>
                                        <tr style="<%= isFuture ? 'background: var(--bg-tertiary);' : '' %>">
                                            <td
                                                style="padding:0.75rem 0.5rem;border-bottom:1px solid var(--border-color); white-space: nowrap; color: var(--text-primary);">
                                                <%= entryDateStr %>
                                                    <% if (isFuture) { %>
                                                        <span
                                                            style="color: var(--info-color); font-size: 0.75rem; margin-left: 0.25rem;">üìÖ
                                                            T∆∞∆°ng lai</span>
                                                        <% } %>
                                            </td>
                                            <td
                                                style="padding:0.75rem 0.5rem;border-bottom:1px solid var(--border-color); text-align: center;">
                                                <% if (entry.had_leakage) { %>
                                                    <span style="color: var(--danger-color);font-weight:bold;">‚ö†Ô∏è</span>
                                                    <% } else { %>
                                                        <span
                                                            style="color: var(--success-color);font-weight:bold;">‚úÖ</span>
                                                        <% } %>
                                            </td>
                                            <td style="padding:0.75rem 0.5rem;border-bottom:1px solid var(--border-color); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-primary);"
                                                class="hide-on-small">
                                                <%= entry.note || '-' %>
                                            </td>
                                            <td
                                                style="padding:0.75rem 0.5rem;border-bottom:1px solid var(--border-color); text-align: center; white-space: nowrap;">
                                                <a href="/entries/<%= entryDateStr %>"
                                                    style="color: var(--info-color); padding: 0.25rem 0.5rem; font-size: 0.9rem;">‚úèÔ∏è</a>
                                                <form method="POST" action="/entries/<%= entry.id %>/delete"
                                                    style="display:inline;"
                                                    onsubmit="return confirm('Xo√° ghi ch√©p ‚Äú<%= entry.had_leakage ? 'S∆° su·∫•t' : 'Thanh t·ªãnh' %>‚Äù ng√†y <%= entryDateStr %><%= isFuture ? ' (ng√†y t∆∞∆°ng lai)' : '' %>?');">
                                                    <button type="submit"
                                                        style="background:none;border:none;color: var(--danger-color);cursor:pointer;padding:0.25rem 0.5rem; font-size: 0.9rem;">üóëÔ∏è</button>
                                                </form>
                                            </td>
                                        </tr>
                                        <% }); %>
                                </tbody>
                            </table>
                        </div>
                        <% } else { %>
                            <div
                                style="color: var(--text-muted);text-align:center;padding:2rem; background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 10px var(--shadow-color);">
                                Ch∆∞a c√≥ ghi ch√©p ti·∫øn ƒë·ªô. H√£y ghi ch√©p ng√†y ƒë·∫ßu ti√™n!</div>
                            <% } %>
        </div>

        <style>
            @media (max-width: 480px) {
                .hide-on-small {
                    display: none;
                }
            }
        </style>

        <%- include('partials/footer') %>
</body>

</html>