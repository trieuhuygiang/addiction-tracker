<script>
    // Apply background video state immediately (server-side setting)
    (function () {
        const serverBackgroundEnabled = <%= backgroundVideoEnabled %>;
        if (!serverBackgroundEnabled) {
            // Add CSS to hide background immediately
            const style = document.createElement('style');
            style.id = 'bg-override';
            style.textContent = '.video-background { display: none !important; }';
            document.head.appendChild(style);
        } else {
            // Immediately try to play video as soon as DOM loads
            document.addEventListener('DOMContentLoaded', function () {
                const video = document.getElementById('bg-video');
                if (video) {
                    video.muted = true;
                    video.volume = 0;
                    video.play().catch(e => console.log('Initial play failed:', e));

                    // Retry every 200ms for first 2 seconds
                    let attempts = 0;
                    const retryInterval = setInterval(() => {
                        if (video.paused && attempts < 10) {
                            video.play().catch(e => { });
                            attempts++;
                        } else {
                            clearInterval(retryInterval);
                        }
                    }, 200);
                }
            });
        }
    })();
</script>

<!-- Background Video -->
<div class="video-background" id="videoBackground" style="<%= backgroundVideoEnabled ? '' : 'display: none;' %>">
    <video autoplay muted loop playsinline preload="metadata" id="bg-video" webkit-playsinline x5-playsinline>
        <source src="/videos/background.mp4" type="video/mp4">
        <source src="/videos/background.webm" type="video/webm">
    </video>
    <div class="video-overlay"></div>

    <script>
        // Inline immediate autoplay
        (function () {
            const v = document.getElementById('bg-video');
            if (v && <%= backgroundVideoEnabled %>) {
                v.muted = true;
                v.defaultMuted = true;
                v.volume = 0;

                function play() {
                    v.play().catch(() => setTimeout(play, 100));
                }

                play();
                v.addEventListener('loadeddata', play);
                v.addEventListener('canplay', play);
                setInterval(() => { if (v.paused) play(); }, 500);
            }
        })();
    </script>
</div>

<header class="navbar">
    <div class="navbar-container">
        <div class="logo">
            <a href="/">‚ú® Chastity Revire Center</a>
        </div>
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <nav class="nav-menu" id="navMenu">
            <% if (isAuthenticated) { %>
                <ul>
                    <li><a href="/dashboard">üìä Dashboard</a></li>
                    <li><a href="/entries">üìù Log Entry</a></li>
                    <li><a href="/calendar">üìÖ Calendar</a></li>
                    <li><a href="/summary">üìà Summary</a></li>
                    <% if (isAdmin) { %>
                        <li><a href="/admin">üëë Admin</a></li>
                        <li>
                            <button class="background-toggle" id="backgroundToggle" title="Toggle background video">
                                <span class="icon-video-on">üé•</span>
                                <span class="icon-video-off" style="display: none;">üö´</span>
                            </button>
                        </li>
                        <% } %>
                            <li>
                                <form method="POST" action="/logout" style="display: inline;">
                                    <button type="submit" class="logout-link">üö™ Logout</button>
                                </form>
                            </li>
                </ul>
                <% } else { %>
                    <ul>
                        <li><a href="/">üè† Home</a></li>
                        <li><a href="/login">üîê Login</a></li>
                        <li><a href="/signup">‚úçÔ∏è Sign Up</a></li>
                    </ul>
                    <% } %>
        </nav>
    </div>
</header>

<script>
    // Auto-detect timezone and set cookie
    (function () {
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const cookieTimezone = document.cookie.split('; ').find(row => row.startsWith('timezone='));
        const currentTz = cookieTimezone ? decodeURIComponent(cookieTimezone.split('=')[1]) : null;

        // Set cookie if timezone not set or changed
        if (timezone && timezone !== currentTz) {
            // Set cookie for 1 year
            document.cookie = `timezone=${encodeURIComponent(timezone)}; path=/; max-age=31536000; SameSite=Lax`;
            // Reload to apply new timezone
            window.location.reload();
        }
    })();

    // Background Video Toggle for Admin (Global - affects all users)
    (function () {
        const backgroundToggle = document.getElementById('backgroundToggle');
        const videoBackground = document.getElementById('videoBackground');
        const bgVideo = document.getElementById('bg-video');
        const iconVideoOn = document.querySelector('.icon-video-on');
        const iconVideoOff = document.querySelector('.icon-video-off');

        // Aggressive autoplay with multiple retry attempts
        function forceVideoPlay() {
            if (!bgVideo || !videoBackground || videoBackground.style.display === 'none') {
                return;
            }

            // Ensure proper attributes for autoplay
            bgVideo.muted = true;
            bgVideo.setAttribute('muted', '');
            bgVideo.setAttribute('playsinline', '');
            bgVideo.setAttribute('autoplay', '');
            bgVideo.defaultMuted = true;
            bgVideo.volume = 0;

            // Immediate play - no promise handling
            try {
                bgVideo.play();
            } catch (e) { }

            // Multiple play attempts with different timings
            const playAttempts = [0, 50, 100, 200, 300, 500, 800, 1000, 1500, 2000];
            playAttempts.forEach((delay) => {
                setTimeout(() => {
                    if (bgVideo.paused) {
                        bgVideo.play().then(() => {
                            console.log('‚úÖ Video started at', delay, 'ms');
                        }).catch(err => {
                            console.log('Retry at', delay, 'ms:', err.message);
                        });
                    }
                }, delay);
            });

            // Continuous monitoring - keep trying to play if paused
            const keepAlive = setInterval(() => {
                if (bgVideo.paused && videoBackground.style.display !== 'none') {
                    bgVideo.play().catch(() => { });
                }
            }, 500);

            // Stop monitoring after 10 seconds
            setTimeout(() => clearInterval(keepAlive), 10000);
        }

        // Function to apply background state
        function applyBackgroundState(isEnabled) {
            const styleOverride = document.getElementById('bg-override');

            if (isEnabled) {
                // Enable video
                if (styleOverride) {
                    styleOverride.remove();
                }
                if (videoBackground) {
                    videoBackground.style.display = 'block';
                }
                if (bgVideo) {
                    forceVideoPlay();
                }
                if (iconVideoOn) iconVideoOn.style.display = 'inline';
                if (iconVideoOff) iconVideoOff.style.display = 'none';
            } else {
                // Disable video
                if (!styleOverride) {
                    const style = document.createElement('style');
                    style.id = 'bg-override';
                    style.textContent = '.video-background { display: none !important; }';
                    document.head.appendChild(style);
                }
                if (videoBackground) {
                    videoBackground.style.display = 'none';
                }
                if (bgVideo) {
                    bgVideo.pause();
                }
                if (iconVideoOn) iconVideoOn.style.display = 'none';
                if (iconVideoOff) iconVideoOff.style.display = 'inline';
            }
        }

        // Get current state from server
        const serverBackgroundEnabled = <%= backgroundVideoEnabled %>;
        applyBackgroundState(serverBackgroundEnabled);

        // Additional mobile-specific fixes
        if (bgVideo) {
            // Try to play when video can play
            bgVideo.addEventListener('canplay', () => {
                if (serverBackgroundEnabled && videoBackground.style.display !== 'none') {
                    forceVideoPlay();
                }
            });

            // Retry play when page becomes visible (for mobile background/foreground switching)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && serverBackgroundEnabled && videoBackground.style.display !== 'none') {
                    forceVideoPlay();
                }
            });
        }

        // Toggle button click handler
        if (backgroundToggle) {
            backgroundToggle.addEventListener('click', async () => {
                try {
                    console.log('Toggling background video...');

                    // Call API to toggle globally
                    const response = await fetch('/api/settings/background-video/toggle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });

                    console.log('Response status:', response.status);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Toggle response:', data);
                        applyBackgroundState(data.enabled);

                        // Show notification
                        alert(`Background video ${data.enabled ? 'enabled' : 'disabled'} for all users`);

                        // Reload page to sync with server
                        setTimeout(() => window.location.reload(), 500);
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to toggle background video:', response.status, errorText);
                        alert('Failed to toggle background video. Status: ' + response.status);
                    }
                } catch (error) {
                    console.error('Error toggling background video:', error);
                    alert('Error toggling background video: ' + error.message);
                }
            });
        } else {
            console.log('Background toggle button not found');
        }
    })();
</script>